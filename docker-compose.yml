services:
  traefik:
    image: traefik:3.6
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    networks:
      - traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./engine/traefik/dynamic/dev:/dynamic:ro
      - ./.cache/ssl:/etc/ssl:ro
      - ./geoip:/plugins/geoip:ro   # dossier contenant GeoLite2-Country.mmdb
      - ./geoip/geoblock:/plugins-local/src/github.com/PascalMinder/geoblock:ro
    command:
      #entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"
      # Attach the static configuration tls.yaml file that contains the tls configuration settings
      - "--providers.file.filename=/dynamic/tls.yaml"
      # Providers 
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=traefik"
      # API & Dashboard 
      - "--api.dashboard=true"
      - "--api.insecure=false"
      # Observability 
      - "--log.level=INFO"
      - "--accesslog=false"
      # Plugins
      # - "--experimental.plugins.geoblock.moduleName=github.com/PascalMinder/geoblock"
      # - "--experimental.plugins.geoblock.version=v0.3.3"
      # - "--experimental.localPlugins.geoblock.moduleName=github.com/PascalMinder/geoblock"
    labels:
      # Enable self-routing
      - "traefik.enable=true"
      # Dashboard router
      - "traefik.http.routers.dashboard.rule=Host(`traefik.dev.tripleperformance.fr`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.tls=true"
      # Basicâ€‘auth middleware
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=$TRAEFIKUSER:$TRAEFIKPASSWORD"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth@docker"
      
  web:
    build:
      context: .
      dockerfile: engine/php_server/Dockerfile
      target: base
      args:
        - DEBUG_TOOLS=true
    env_file: .env
    volumes:
      - ./:/var/www
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`wiki.dev.tripleperformance.fr`) || Host(`demo.dev.tripleperformance.fr`) || Host(`fr.dev.tripleperformance.ag`) || Host(`ar.dev.tripleperformance.ag`) || Host(`en.dev.tripleperformance.ag`) || Host(`de.dev.tripleperformance.ag`) || Host(`es.dev.tripleperformance.ag`) || Host(`fi.dev.tripleperformance.ag`) || Host(`pt.dev.tripleperformance.ag`) || Host(`it.dev.tripleperformance.ag`) || Host(`el.dev.tripleperformance.ag`) || Host(`hu.dev.tripleperformance.ag`) || Host(`pl.dev.tripleperformance.ag`) || Host(`nl.dev.tripleperformance.ag`)"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.services.web.loadbalancer.server.port=80"     
      # - "traefik.http.routers.web.middlewares=geoblock-china@file"
    networks:
      default:
        aliases:
          - wiki.dev.tripleperformance.fr
          - demo.dev.tripleperformance.fr
          - de.dev.tripleperformance.ag
          - en.dev.tripleperformance.ag
          - es.dev.tripleperformance.ag
          - fr.dev.tripleperformance.ag
          - it.dev.tripleperformance.ag
          - nl.dev.tripleperformance.ag
          - pl.dev.tripleperformance.ag
          - el.dev.tripleperformance.ag
          - ar.dev.tripleperformance.ag
          - hu.dev.tripleperformance.ag
          - fi.dev.tripleperformance.ag
          - pt.dev.tripleperformance.ag
      traefik:
        aliases:
          - wiki.dev.tripleperformance.fr
          - demo.dev.tripleperformance.fr
          - de.dev.tripleperformance.ag
          - en.dev.tripleperformance.ag
          - es.dev.tripleperformance.ag
          - fr.dev.tripleperformance.ag
          - it.dev.tripleperformance.ag
          - ar.dev.tripleperformance.ag
          - nl.dev.tripleperformance.ag
          - pl.dev.tripleperformance.ag
          - el.dev.tripleperformance.ag
          - hu.dev.tripleperformance.ag
          - fi.dev.tripleperformance.ag
          - pt.dev.tripleperformance.ag

  insights_php:
    build:
      context: insights
      dockerfile: dockerfiles/php/Dockerfile
      target: base
      args:
        - DEBUG_TOOLS=true
    user: "${UID:-1000}:${GID:-1000}"
    networks:
      traefik:
      default:
    volumes:
      - ./insights:/var/www/html
      - ./.cache/composer:/.composer

  insights:
    image: nginx:1.28
    volumes:
      - ./insights:/var/www/html
      - ./insights/dockerfiles/php/cnpg.conf:/etc/nginx/conf.d/default.conf
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.insights.rule=Host(`insights.dev.tripleperformance.fr`)"
      - "traefik.http.routers.insights.entrypoints=websecure"
      - "traefik.http.routers.insights.tls=true"
      - "traefik.http.services.insights.loadbalancer.server.port=80"
    networks:
      traefik:
      default:
        aliases:
          - insights.dev.tripleperformance.fr

  db:
    image: mysql:5.7
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max_allowed_packet=64M
    environment:
      - MYSQL_USERNAME=root
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=wiki
      - MYSQL_USER=wiki
      - MYSQL_PASSWORD=wiki
    volumes:
      - data-mysql:/var/lib/mysql
      - ./bin/sql:/var/sql

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.phpmyadmin.rule=Host(`phpmyadmin.dev.tripleperformance.fr`)"
      - "traefik.http.routers.phpmyadmin.entrypoints=websecure"
      - "traefik.http.routers.phpmyadmin.tls=true"
      - "traefik.http.services.phpmyadmin.loadbalancer.server.port=80"
    networks:
      - default
      - traefik

  redis:
    image: redis

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
    environment:
      discovery.type: single-node
      xpack.security.enabled: "true"
      http.cors.enabled: "true"
      http.cors.allow-origin: "https://elasticvue.dev.tripleperformance.fr"
      http.cors.allow-headers: X-Requested-With,Content-Type,Content-Length,Authorization
    ulimits:
      memlock:
        soft: -1
        hard: -1
    networks:
      - default
      - traefik  
    volumes:
      - data01:/usr/share/elasticsearch/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.elasticsearch.rule=Host(`elasticsearch.dev.tripleperformance.fr`)"
      - "traefik.http.routers.elasticsearch.entrypoints=websecure"
      - "traefik.http.routers.elasticsearch.tls=true"
      - "traefik.http.services.elasticsearch.loadbalancer.server.port=9200"

  elasticvue:
    image: cars10/elasticvue
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.elasticvue.rule=Host(`elasticvue.dev.tripleperformance.fr`)"
      - "traefik.http.routers.elasticvue.entrypoints=websecure"
      - "traefik.http.routers.elasticvue.tls=true"
      - "traefik.http.services.elasticvue.loadbalancer.server.port=8080"
    networks:
      - default
      - traefik

  wordpress:
    image: wordpress
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: wordpressuser
      WORDPRESS_DB_PASSWORD: examplepass
      WORDPRESS_DB_NAME: wordpress
    restart: unless-stopped
    volumes:
      - ./wordpress:/var/www/html
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wordpress.rule=Host(`wordpress.dev.tripleperformance.fr`)"
      - "traefik.http.routers.wordpress.entrypoints=websecure"
      - "traefik.http.routers.wordpress.tls=true"
      - "traefik.http.services.wordpress.loadbalancer.server.port=80"
    profiles:
      - wordpress
    networks:
      - default
      - traefik

  piwigo:
    image: lscr.io/linuxserver/piwigo:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    volumes:
      - ./piwigo/config:/config
      - ./piwigo/gallery:/gallery
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.piwigo.rule=Host(`photos.dev.tripleperformance.fr`)"
      - "traefik.http.routers.piwigo.entrypoints=websecure"
      - "traefik.http.routers.piwigo.tls=true"
      - "traefik.http.services.piwigo.loadbalancer.server.port=80"        
    networks:
      traefik:
      default:
        aliases:
          - photos.dev.tripleperformance.fr

  matomo:
    image: matomo
    restart: unless-stopped
    environment:
      - MATOMO_DATABASE_HOST=db
    volumes:
      - matomo:/var/www/html:z
    networks:
      - default
      - traefik      
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.matomo.rule=Host(`matomo.dev.tripleperformance.fr`)"
      - "traefik.http.routers.matomo.entrypoints=websecure"
      - "traefik.http.routers.matomo.tls=true"
      - "traefik.http.services.matomo.loadbalancer.server.port=80"        

  n8n:
    image: docker.n8n.io/n8nio/n8n
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.dev.tripleperformance.fr`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    networks:
      - default
      - traefik      
    environment:
      - N8N_HOST=n8n.dev.tripleperformance.fr
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - WEBHOOK_URL=https://n8n.dev.tripleperformance.fr/
      - GENERIC_TIMEZONE=Europe/Paris
      - N8N_EMAIL_MODE
      - N8N_SMTP_HOST
      - N8N_SMTP_USER
      - N8N_SMTP_PASS
      - N8N_SMTP_SENDER
      - N8N_SMTP_PORT
      - N8N_SMTP_SSL
      - N8N_SMTP_TLS      
    volumes:
      - n8n_data:/home/node/.n8n
      - ./backup/n8n:/files
      - './downloads:/downloads'

  yt-dlp:
    command: yt-dlp-webui
    image: ghcr.io/alexta69/metube
    restart: unless-stopped
    environment:
      - 'YTDL_OPTIONS={"format":"bestaudio[ext=m4a]", "postprocessors":[{"key":"Exec","exec_cmd":"sh /downloads/compress-audio.sh","when":"after_move"}]}'
      - 'OUTPUT_TEMPLATE=%(id)S.%(ext)s'
    volumes:
      - './backup/n8n:/downloads'
    ports:
      - "8081:8081"

  pdf-to-image:
    restart: unless-stopped
    image: joanfabregat/pdf2img

  chrome-headless:
    image: ghcr.io/browserless/chromium
    restart: unless-stopped
    environment:
      - CONCURRENT=10
      - TOKEN=6R0W53R135510

  itk-info:
    image: ghcr.io/neayi/itk-info:latest
    ports:
      - "3000:3000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PORT=3000
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.itkinfo.rule=Host(`itk-info.dev.tripleperformance.fr`)"
      - "traefik.http.routers.itkinfo.entrypoints=websecure"
      - "traefik.http.routers.itkinfo.tls=true"
      - "traefik.http.services.itkinfo.loadbalancer.server.port=3000"
    networks:
      - default
      - traefik

  bugsink:
    image: bugsink/bugsink:latest
    environment:
      - SECRET_KEY=${BUGSINK_SECRET_KEY}
      - ALLOWED_HOSTS=bugsink.tripleperformance.fr,bugsink.dev.tripleperformance.fr,localhost,bugsink
      - DEBUG=false
      - EMAIL_HOST=${N8N_SMTP_HOST}
      - EMAIL_PORT=${N8N_SMTP_PORT}
      - EMAIL_HOST_USER=${N8N_SMTP_USER}
      - EMAIL_HOST_PASSWORD=${N8N_SMTP_PASS}
      - EMAIL_USE_TLS=false
      - EMAIL_USE_SSL=false
      - DEFAULT_FROM_EMAIL=${N8N_SMTP_SENDER}
      - SERVER_EMAIL=${N8N_SMTP_SENDER}
      - DEBUG_CSRF=True
      - BEHIND_HTTPS_PROXY=True
    restart: unless-stopped      
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bugsink.rule=Host(`bugsink.dev.tripleperformance.fr`)"
      - "traefik.http.routers.bugsink.entrypoints=websecure"
      - "traefik.http.routers.bugsink.tls=true"
      - "traefik.http.services.bugsink.loadbalancer.server.port=8000"
    networks:
      - default
      - traefik  

networks:
  default: ~
  traefik:
    name: traefik

volumes:
  matomo:
    driver: local
  data-mysql:
    driver: local
  data01:
    driver: local
  n8n_data:
    driver: local
